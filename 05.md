# DNS相关工具配置，包括 DNSCrypt-proxy 和 DNSmasq
##### 在 Ubuntu 12.04 LTS 测试，为了尝鲜最新版本，这里采用编译安装方式，同时禁用 Ubuntu 自带的 DNSmasq

## IPtables 开机应用

#### IPtables u32模块 防污染 （需要定期更新GFW IP）
```sh
iptables -I INPUT -p udp -m udp --sport 53 -m u32 --u32 "0&0x0F000000=0x05000000 && 22&0xFFFF@16=0x01010101,0xffffffff,0x4a7d7f66,0x4a7d9b66,0x4a7d2766,0x4a7d2771,0xd155e58a,0x042442b2,0x0807c62d,0x253d369e" -j DROP
iptables -I INPUT -p udp -m udp --sport 53 -m u32 --u32 "0&0x0F000000=0x05000000 && 22&0xFFFF@16=0x2e52ae44,0x3b1803ad,0x402158a1,0x4021632f,0x4042a3fb,0x4168cafc,0x41a0db71,0x422dfced,0x480ecd68,0x480ecd63" -j DROP
iptables -I INPUT -p udp -m udp --sport 53 -m u32 --u32 "0&0x0F000000=0x05000000 && 22&0xFFFF@16=0x4e10310f,0x5d2e0859,0x80797e8b,0x9f6a794b,0xa9840d67,0xc043c606,0xca6a0102,0xcab50755,0xcba1e6ab,0xcb620741" -j DROP
iptables -I INPUT -p udp -m udp --sport 53 -m u32 --u32 "0&0x0F000000=0x05000000 && 22&0xFFFF@16=0xcf0c5862,0xd0381f2b,0xd1913632,0xd1dc1eae,0xd1244921,0xd35e4293,0xd5a9fb23,0xd8ddbcb6,0xd8eab30d,0xf3b9bb03" -j DROP
iptables -I INPUT -p udp -m udp --sport 53 -m u32 --u32 "0&0x0F000000=0x05000000 && 22&0xFFFF@16=0xf3b9bb27,0x1759053c,0x31027b38,0x364c8701,0x4d04075c,0x76053106,0xbc050460,0xbda31105,0xc504040c,0xfd9d0ea5" -j DROP
iptables -I INPUT -p udp -m udp --sport 53 -m u32 --u32 "0&0x0F000000=0x05000000 && 22&0xFFFF@16=0xf9812e30" -j DROP
iptables -I FORWARD -p udp -m udp --sport 53 -m u32 --u32 "0&0x0F000000=0x05000000 && 22&0xFFFF@16=0x01010101,0xffffffff,0x4a7d7f66,0x4a7d9b66,0x4a7d2766,0x4a7d2771,0xd155e58a,0x042442b2,0x0807c62d,0x253d369e" -j DROP
iptables -I FORWARD -p udp -m udp --sport 53 -m u32 --u32 "0&0x0F000000=0x05000000 && 22&0xFFFF@16=0x2e52ae44,0x3b1803ad,0x402158a1,0x4021632f,0x4042a3fb,0x4168cafc,0x41a0db71,0x422dfced,0x480ecd68,0x480ecd63" -j DROP
iptables -I FORWARD -p udp -m udp --sport 53 -m u32 --u32 "0&0x0F000000=0x05000000 && 22&0xFFFF@16=0x4e10310f,0x5d2e0859,0x80797e8b,0x9f6a794b,0xa9840d67,0xc043c606,0xca6a0102,0xcab50755,0xcba1e6ab,0xcb620741" -j DROP
iptables -I FORWARD -p udp -m udp --sport 53 -m u32 --u32 "0&0x0F000000=0x05000000 && 22&0xFFFF@16=0xcf0c5862,0xd0381f2b,0xd1913632,0xd1dc1eae,0xd1244921,0xd35e4293,0xd5a9fb23,0xd8ddbcb6,0xd8eab30d,0xf3b9bb03" -j DROP
iptables -I FORWARD -p udp -m udp --sport 53 -m u32 --u32 "0&0x0F000000=0x05000000 && 22&0xFFFF@16=0xf3b9bb27,0x1759053c,0x31027b38,0x364c8701,0x4d04075c,0x76053106,0xbc050460,0xbda31105,0xc504040c,0xfd9d0ea5" -j DROP
iptables -I FORWARD -p udp -m udp --sport 53 -m u32 --u32 "0&0x0F000000=0x05000000 && 22&0xFFFF@16=0xf9812e30" -j DROP
```

#### IPtables string模块 防污染 （需要定期更新GFW IP）

这个模块的缺点是相对来说CPU消耗比 u32 要高,以前的linux系统中默认都不会包含这个 mod.相对 u32 模块只能精确匹配 4 个字节的弱势(这也是 u32 节约资源的重要原因，因为指定位置后不存在搜索的运算)，string模块提供了字符串搜索能力，只要返回的数据里有特定的字符就可以识别出来，这样就不用担心不同类型的DNS服务器返回的数据格式不同了。
```sh
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|01010101|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|02010102|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|042442B2|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|04C15000|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|0807C62D|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|08695400|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|0A0A0A0A|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|0C578500|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|0E66F912|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|103F9B00|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|14141414|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|148B3800|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|1759053C|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|1833B800|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|1C0DD800|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|1C797E8B|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|253D369E|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|2E147EFC|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|2E2618D1|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|2E52AE44|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|31027B38|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|364C8701|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|3B1803AD|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|3D361C06|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|402158A1|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|4021632F|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|4042A3FB|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|4168CAFC|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|41A0DB71|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|422DFCED|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|42CE0BC2|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|480ECD63|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|480ECD68|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|4A75398A|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|4A7D1F71|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|4A7D2766|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|4A7D2771|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|4A7D7F66|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|4A7D822F|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|4A7D9B66|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|4D04075C|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|4E10310F|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|591F376A|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|5D2E0859|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|710BC2BE|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|76053106|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|7ADA65BE|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|7B3231AB|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|7B7EF9EE|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|7DE69430|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|7F000002|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|80797E8B|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|9F6A794B|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|A9840D67|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|ADC9D806|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|BC050460|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|BDA31105|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|C043C606|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|C504040C|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|CA6A0102|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|CAB50755|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|CB620741|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|CBA1E6AB|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|CBC73951|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|CF0C5862|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|D0381F2B|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|D06D8A37|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|D1244921|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|D155E58A|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|D1913632|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|D1DC1EAE|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|D2F27D14|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|D3058512|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|D308451B|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|D35E4293|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|D5A9FB23|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|D5BA2105|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|D88BD590|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|D8DDBCB6|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|D8EAB30D|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|DD08451B|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|F3B9BB03|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|F3B9BB1E|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|F3B9BB27|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|F9812E30|" --from 60 --to 180  -j DROP
iptables -t mangle -I PREROUTING -p udp --sport 53 -m string --algo bm --hex-string "|FD9D0EA5|" --from 60 --to 180  -j DROP
```

`-m string`表示启用string模块进行匹配,`–algo bm`表示启用贝叶(Boyer-Moore)字符串搜索算法,另一种算法是kmp(Knuth-Pratt-Morris)

`–hex-string`就是要匹配的IP地址的HEX格式了,注意这里前面不要有0x表示16进制了,直接写16进制数据就行,后面跟着的就是IP地址的16进制格式.

`–from 60 –to 180`都是表示搜索的偏置范围(offset),从第60 byte开始到180 byte结束,一般来说DNS返回包的长度很少有超过180字节,而IP值的位置因为协议格式的关系,基本上不可能出现在60字节之前,所以指定这个范围是足够的,同时也可以大大减轻搜索算法的运算压力.如果你担心有什么奇葩DNS返回的结果在这范围之外,删除这两个偏置选项就行了,这样会默认搜索整个字符串,但相应的搜索消耗的CPU资源就更多了.

#### 开机自动加载iptables配置

iptables配置完成后，如果不做设置，机器重启后，规则会丢失

iptables配置完成后执行:

```
$ passwd root  
$ su root  
sudo iptables-save > /etc/init.d/iptables.up.rules  
```

将当前配置保存在 `iptables.up.rules` 文件中，文件名可以随意。

修改网卡配置文件，在网卡IP配置文件 `/etc/network/interfaces` 末行加入

```
sudo gedit /etc/network/interfaces  
/*   add the line below  */  
pre-up iptables-restore < /etc/init.d/iptables.up.rules  
```

最后重启验证

## DNSCrypt-proxy

### 编译安装过程

#### 编译安装依赖 libsodium

##### 1. 下载源代码

点击链接找最新的[tarball of libsodium](https://download.libsodium.org/libsodium/releases/),比如 `libsodium-<version>.tar.gz`

##### 2. 验证完整性

计算 SHA256:

    $ openssl dgst -sha256 libsodium-<version>.tar.gz

使用 dig 验证SHA256:

    $ dig +dnssec +short txt libsodium-<version>.tar.gz.download.libsodium.org

如果匹配则继续下面的操作，否则去官方 GitHub 报告，**不要继续进行**

##### 3. 编译安装

    $ tar zxvf libsodium-<version>.tar.gz
    $ cd libsodium-<version>/
    $ ./configure
    $ make -j CORE_NUMBER && make check
    # make install
    # ldconfig       /*   root 下重新载入模块  */

#### 编译安装 dnscrypt-proxy

##### 1. 下载源代码

从这里下载: [dnscrypt download](https://github.com/jedisct1/dnscrypt-proxy/releases)

##### 2. 验证完整性

计算 SHA256:

    $ openssl dgst -sha256 dnscrypt-proxy-<version>.tar.bz2

使用 dig 验证SHA256:

    $ dig +dnssec TXT dnscrypt-proxy-<version>.tar.bz2.download.dnscrypt.org

如果匹配则继续下面的操作，否则去官方 GitHub 报告，**不要继续进行**

##### 3. 编译安装

    /* 在 Fedora, RHEL and CentOS 上安装 必须在 `ldconfig` 之前 */
    $ su root
    # echo /usr/local/lib > /etc/ld.so.conf.d/usr_local_lib.conf
    # ldconfig
    # exit
    /*            Ubuntu 标准安装                              */
    $ bunzip2 -cd dnscrypt-proxy-*.tar.bz2 | tar xvf -
    $ cd dnscrypt-proxy-*/
    $ ./configure && make -j CORE_NUMBER
    # make install
    # ldconfig

默认安装在 `/usr/local/sbin/dnscrypt-proxy` 

    man 8 dnscrypt-proxy  # 查看详细帮助信息

### 启动脚本配置以及使用

#### 1. 创建专用系统账户

    /* 理论上都可以使用  未完全测试，建议创建 带有空家目录的专用无权限系统账户  */
    # adduser --system --home /home/dnscrypt --disabled-password --disabled-login dnscrypt
    # useradd --home-dir /home/dnscrypt --create-home --system --user-group dnscrypt

#### 2. 配置启动脚本

创建脚本文件 `# touch /etc/init/dnscrypt.conf`  

脚本中不需要出现 daemon 的内容，比如这里的 `--daemonize`  
其中的 `--resolver-name` 可以在[public DNS resolvers supporting DNSCrypt](https://github.com/jedisct1/dnscrypt-proxy/blob/master/dnscrypt-resolvers.csv)中的 `Name` 列找，目前使用的是 `opendns`  
其中 `--tcp-only` 因为性能问题不建议使用，除非必须要用来突破DNS污染  


    description "dnscrypt startup script"

    start on (local-filesystems and started dbus and stopped udevtrigger)
    stop on runlevel [016]

    script
            exec /usr/local/sbin/dnscrypt-proxy --resolver-name=cloudns-can --local-address=127.0.0.9:35535 --user=dnscrypt --logfile=/var/log/dnscrypt.log --pidfile=/var/run/dnscrypt.pid
    end script

之后软连接到 `/etc/init.d` 目录下

    # ln -s /lib/init/upstart-job /etc/init.d/dnscrypt


注： `--resolver-name=cloudns-can` 有 DNSSEC, No-log 和 Namecoin ， 方便突破封鎖

#### 3. 启动和停止

    # killall -KILL dnscrypt-proxy  // 或者使用 pid 
    # start dnscrypt                // 在 /etc/init.d 中的名称
    
## DNSmasq

### 禁用 Ubuntu 自带 DNSmasq

`# vim /etc/NetworkManager/NetworkManager.conf`，把 dns=dnsmasq 注释掉，之后重启服务

    # service network-manager restart

### 编译安装过程

##### 1. 下载源代码

从这里下载: [DNSmasq](http://www.thekelleys.org.uk/dnsmasq/)，比如 `dnsmasq-<version>.tar.gz`

##### 2. 编译安装

    /*            Ubuntu 标准安装          */
    $ tar zxvf dnsmasq-<version>.tar.gz
    $ cd dnsmasq-<version>/
    $ make -j CORE_NUMBER
    # make install

默认安装在 `/usr/local/sbin/dnsmasq` 

    man 8 dnsmasq  # 查看详细帮助信息

### 启动脚本配置以及使用

#### 1. 创建专用系统账户

    /* 理论上都可以使用  未完全测试，建议创建 带有空家目录的专用无权限系统账户  */
    # adduser --system --home /home/dnsmasq --disabled-password --disabled-login dnsmasq
    # useradd --home-dir /home/dnsmasq --create-home --system --user-group dnsmasq

#### 2. 配置启动脚本

创建脚本文件 `# touch /etc/init/dnsmasq.conf`  

脚本中不需要出现 daemon 的内容  

    description "dnsmasq startup script"

    start on (local-filesystems and started dbus and stopped udevtrigger)
    stop on runlevel [016]

    script
            exec /usr/local/sbin/dnsmasq --conf-file=/etc/dnsmasq.conf
    end script

之后软连接到 `/etc/init.d` 目录下

    # ln -s /lib/init/upstart-job /etc/init.d/dnsmasq

#### 3. 启动和停止

    # killall -KILL dnsmasq        // 或者使用 pid 
    # start dnsmasq                // 在 /etc/init.d 中的名称

#### 4. 卸载

    # make uninstall              // dnsmasq 一般没有 uninstall 字段
    # make clean
    $ chmod +x clean_compile_soft.py
    # ./clean_compile_soft.py
    

卸载脚本 `clean_compile_soft.py` 在[Scripts repository](https://github.com/wongsyrone/Scripts)

#### 4. 配置 dnsmasq

NetworkManager 设置当前连接DNS为 `127.0.0.1` 即可使用本地 DNSmasq 进行解析和缓存

创建默认位置配置文件 `# touch /etc/dnsmasq.conf`，我们可以把大量文本配置放在`/etc/dnsmasq.d`文件夹中，然后使用`conf-dir`选项指定配置文件目录，目录中**不要**放置其他文件,这样看起来也比较整洁。另外dnsmasq配置文件可参考我的[OpenWRT配置](https://github.com/wongsyrone/OpenWrt)

    no-resolv
    no-poll
    all-servers

    conf-dir=/etc/dnsmasq.d
    user=dnsmasq
    group=dnsmasq
    
    listen-address=127.0.0.1
        
    # log for debug purpose
    # log-queries
    # log-facility=/var/log/dnsmasq.log
        
    # Find more rules there, including accelerate and ISP block rules
    #   (https://github.com/felixonmars/dnsmasq-china-list)
    
    # special forward rules
    server=/launchpad.net/8.8.8.8
    

## 启动模板以及使用

### 模板内容

    description "<what you put, that is to say,to startup something you need>"

    start on (local-filesystems and started dbus and stopped udevtrigger)
    stop on runlevel [016]

    script
            exec <path-to-the-executable-file> <the-parameters-needed_without_daemon_param>
    end script


### 添加到系统

    # cp <template-file>.conf /etc/init/
    # ln -s /lib/init/upstart-job   /etc/init.d/<the-name-of-template-file>

### 使用

    # start <the-name-of-template-file>
    # stop <the-name-of-template-file>

